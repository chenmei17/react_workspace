<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STOMP Room Chat - UI Only</title>

  
  <!-- React CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SockJS + STOMP (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:white; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.07); padding: 16px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .row > * { margin: 4px 0; }
    input, select { padding: 10px; border-radius: 10px; border: 1px solid #d9dbe3; outline: none; }
    button { padding: 10px 14px; border: none; border-radius: 10px; cursor:pointer; }
    button.primary { background:#2e6cff; color:white; }
    button.ghost { background:#eef1ff; }
    .status { font-size: 13px; color:#555; }
    .chatBox { height: 420px; overflow:auto; background:#0b1020; color:#e9ecff; border-radius: 14px; padding: 12px; }
    .msg { padding: 10px; border-radius: 12px; margin: 8px 0; background: rgba(255,255,255,0.06); }
    .meta { font-size: 12px; opacity: 0.85; margin-bottom: 4px; }
    .text { font-size: 14px; white-space: pre-wrap; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(255,255,255,0.14); margin-left: 6px; font-size: 12px; }
    hr { border: 0; border-top: 1px solid #eee; margin: 14px 0; }
    code { background: #f1f3f8; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div id="app"></div>

  <script type="text/babel">
    
    function App(){
      /* ---------------------------------
        ë°”ì¸ë“œ ë³€ìˆ˜ (ìƒíƒœë³€ìˆ˜)
        ì»´í¬ë„ŒíŠ¸ì™€ í•¨ê»˜ ì‚´ì•„ê°€ë©° UI ì™€ í›„í‚¹ ë˜ì–´ìˆë‹¤.       
      --------------------------------- */
      const [name,setName] = React.useState("");
      const [roomId,setRoomId] = React.useState("");
    
      
      /* ---------------------------------
        Ref ë³€ìˆ˜
        ì»´í¬ë„ŒíŠ¸ì™€ í•¨ê»˜ì‚´ë©° UI ì™€ ìƒê´€ì—†ëŠ” ë³€ìˆ˜ 
        ë¬´ì–¸ê°€ ë‹´ì„ë• ê°ì²´ ìì²´ì— ë‹´ëŠ”ê²Œ ì•„ë‹ˆê³  current property ì— ë‹´ì•„ì•¼ë¨ 
      --------------------------------- */
      const stompRef = React.useRef(null); // ì €ì¥ ì ‘ì†ê°ì²´ 
      
      
      /* ---------------------------------
      ì»´í¬ë„ŒíŠ¸ ëœë”ë§ ì§í›„ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      --------------------------------- */
      React.useEffect(() => {
  
        fetch("http://localhost:9992/api/auth/me",{
          method:"GET",
          credentials:"include"
          // => ì„¸ì…˜ê³¼ ì¿ í‚¤ êµ¬í˜„ì‹œ ... ì¿ í‚¤ë¡œ ë¡œê·¸ì¸ í•˜ë ¤ë©´? ì´ê±° ì¨ì¤˜ì•¼ í•¨ 
          // ì´ê²Œìˆì–´ì•¼ ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ë¥¼ ì„œë²„ì— ì „ì†¡í•œë‹¤. 
        })
        .then(res=> res.json())
        .then(data => {
          // ìš°ì¸¡ ìƒë‹¨ì˜ì—­ì— ì±„íŒ…ì„ ì§„í–‰í•  ì‚¬ëŒì˜ ì´ë¦„ì„ ìë™ì¶œë ¥ ~ 
          setName(data.name);
        })
        .catch(err => console.log("ì¡°íšŒì‹¤íŒ¨"));
      },[]);


      /* ---------------------------------
        ì±„íŒ…ì„œë²„ ì ‘ì†í•˜ê¸° 
      --------------------------------- */
      const connect = () => {
        console.log("ì ‘ì†í•˜ê² ìŠ¨ë‹ˆë‹¤");
        
        // webSocket ì€ í‘œì¤€ì´ê¸´ í•˜ë‚˜ í™˜ê²½ì— ë”°ë¼ ë™ì‘í•˜ì§€ ì•Šì„ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ë¯¸ë¦¬ sockJS ë¥¼ ì‚¬ìš©í•´ ë³´ì (íš¨ê³¼ ë™ì¼)
        const sock = new SockJS("http://localhost:9992/ws/stomp");

        const stomp = Stomp.over(sock);
        // Stomp ëŠ” ë©€í‹°ìºìŠ¤íŒ… ì±„íŒ…ì„ êµ¬ë…ê°œë…ìœ¼ë¡œ ë‹¨ìˆœí™”ì‹œì¼œ ë³´ë‹¤ì‰½ê²Œ ë©”ì„¸ì§€ í†µì‹ ì„ êµ¬í˜„í• ìˆ˜ìˆë‹¤.
        // stomp ëŠ” WebSocket ì´ë‚˜ Sock.js ê¸°ë°˜ìœ„ì—ì„œ ì‹¤í–‰ëœë‹¤. 

        stomp.connect({},()=>{
          console.log("STOMP ì ‘ì† ì„±ê³µ");
          stompRef.current = stomp;
        },(err =>{console.log("STOMP connect error...", err)}));
      }

      /* ---------------------------------
        ì±„íŒ… ì„œë²„ ì ‘ì† í•´ì œí•˜ê¸°  
      --------------------------------- */
      const disconnect = () => {
        console.log("ì ‘ì†í•´ì œ í•˜ê²ŸìŠ¨ë‹ˆë‹¤");
        // ì ‘ì† í•´ì œë¥¼ í•˜ê²Œë˜ë©´ êµ¬ë… ì·¨ì†Œ 


        // ì¡´ì¬ì‹œì—ë§Œ í•´ì œ 
        if(stompref.current){
          stompRef.current.disconnect(()=>{});
          stompRef.current = null;
        }
      }

      /* ---------------------------------
        ë°© ì…ì¥
      --------------------------------- */
      function joinRoom(){
        // ì ‘ì†ì—†ì´ ë°©ì— ë“¤ì–´ê°€ëŠ”ê²ƒì„ ë°©ì§€. 
        if(!stompRef.current || !stompRef.connected){
          alert("ì ‘ì† í›„ ì…ì¥ í•´ ì£¼ì„¸ìš”.");
          return;
        }

        const rid = roomId.trim();// í˜¹ì‹œëª¨ë¥¼ ê³µë°± ë¬¸ì ì œê±° 
        if(!rid){
          alert("ë£¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          return;
        }

        // ê¸°ì¡´ êµ¬ë… ë£¸ì´ ìˆë‹¤ë©´ êµ¬ë… í•´ì œ 

        // ì±„íŒ… ë©”ì„¸ì§€ ì´ˆê¸°í™” 

        // ë£¸ ì°¸ì—¬ì˜ ì˜ë¯¸ëŠ” stopmì±„íŒ… server ì—ê²Œ ì´ ë£¸ì„ êµ¬ë…í•˜ê² ë‹¤ëŠ” ëœ»
        stompRef.subScribe(`/topic/${rid}`,(frame) => {
          // ë°ì´í„° ì „ì†¡ì„ ìœ„í•´ json ë¬¸ìì—´ë¡œ ë³€í™˜ 
          const body = JSON.parse(frame.body);
        });

      }

      const send = () => {
        stompRef.current.send("/app/room/"+roomId+"/send",{},"í•˜ì´ìš¤"); // ìŠ¤í”„ë§ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ìš”ì²­ë°›ìŒ. URI ë¥¼ ì˜ ë§ì¶°ë³´ë‚´ì•¼ í•œë‹¤. 
      }


      return(
        <div className="wrap">
          <div className="card">
            <h2 style={{margin:"0 0 10px 0"}}>Step2+3 - STOMP ì±„íŒ…ë°©(Room) (UI Only)</h2>

            {/* ìƒë‹¨ ìƒíƒœ + ì—°ê²° ë²„íŠ¼ */}
            <div className="row">
              <div className="status">
                <b>Status:</b> <span id="statusText">DISCONNECTED</span>
                {/* Room í‘œì‹œìš© (í•„ìš” ì‹œ ë³´ì´ê²Œ) */}
                <span className="pill" id="roomPill" style={{display:"none"}}>Room 1</span>
              </div>

              <div style={{flex:1}}></div>

              <button className="ghost" type="button" onClick={connect}>Connect</button>
              <button className="ghost" type="button" onClick={disconnect}>Disconnect</button>
            </div>

            <hr />

            {/* ë£¸/ë‹‰ë„¤ì„/ì´ëª¨ì§€ */}
            <div className="row">
              <input
                id="roomId"
                value={roomId}
                placeholder="roomId (ì˜ˆ: 1,2,study)"
                onChange={e=>setRoomId(e.target.value)}
              />
              <button className="primary" type="button" onClick={joinRoom}>Join Room</button>

              <div style={{flex:1}}></div>

              <input
                id="nickname"
                value={name}
                placeholder="ë‹‰ë„¤ì„"
              />

              <select id="emoji">
                <option value="ğŸ™‚">ğŸ™‚</option>
                <option value="ğŸ˜„">ğŸ˜„</option>
                <option value="ğŸ˜">ğŸ˜</option>
                <option value="ğŸ”¥">ğŸ”¥</option>
                <option value="ğŸ‰">ğŸ‰</option>
                <option value="âœ…">âœ…</option>
                <option value="âš ï¸">âš ï¸</option>
                <option value="â¤ï¸">â¤ï¸</option>
              </select>
            </div>

            {/* ì±„íŒ… ë°•ìŠ¤ */}
            <div style={{marginTop:"14px"}} className="chatBox" id="chatBox">
              <div style={{opacity:"0.75"}}>
                ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. Join Room í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.
              </div>

              {/* ì˜ˆì‹œ ë©”ì‹œì§€(ë””ìì¸ í™•ì¸ìš©) */}
              {/*
              <div className="msg">
                <div className="meta">
                  <b>ğŸ™‚ ë°ë¸ŒëŸ°</b>
                  <span style={{marginLeft:"8px"}}>2026-01-23 09:10:11</span>
                </div>
                <div className="text">ì•ˆë…•í•˜ì„¸ìš”! ë””ìì¸ë§Œ ë‚¨ê¸´ UIì…ë‹ˆë‹¤.</div>
              </div>
              */}
            </div>

            {/* ì…ë ¥ + ì „ì†¡ */}
            <div className="row" style={{marginTop:"12px"}}>
              <input
                id="message"
                style={{flex:1, minWidth:"260px"}}
                value=""
                placeholder="ë©”ì‹œì§€ ì…ë ¥"
              />
              <button className="primary" type="button"onClick={send}>Send</button>
            </div>

            <div style={{marginTop:"10px", fontSize:"12px", color:"#666"}}>
              WS ì ‘ì†: <code id="wsUrl">http://host:9992/ws-stomp</code>
              / êµ¬ë…: <code>/topic/room/roomId</code>
              / ì „ì†¡: <code>/app/room/roomId/send</code>
            </div>
          </div>
        </div>
      )
    }

    ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
  </script>
</body>
</html>