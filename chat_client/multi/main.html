<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>STOMP Room Chat (React CDN)</title>

  <!-- React CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SockJS + STOMP (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:white; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.07); padding: 16px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .row > * { margin: 4px 0; }
    input, select { padding: 10px; border-radius: 10px; border: 1px solid #d9dbe3; outline: none; }
    button { padding: 10px 14px; border: none; border-radius: 10px; cursor:pointer; }
    button.primary { background:#2e6cff; color:white; }
    button.ghost { background:#eef1ff; }
    .status { font-size: 13px; color:#555; }
    .chatBox { height: 420px; overflow:auto; background:#0b1020; color:#e9ecff; border-radius: 14px; padding: 12px; }
    .msg { padding: 10px; border-radius: 12px; margin: 8px 0; background: rgba(255,255,255,0.06); }
    .meta { font-size: 12px; opacity: 0.85; margin-bottom: 4px; }
    .text { font-size: 14px; white-space: pre-wrap; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(255,255,255,0.14); margin-left: 6px; font-size: 12px; }
  </style>
</head>
<body>
<div id="app"></div>

<script type="text/babel">

    
    function App(){
        // ui ì™€ ìƒê´€ì—†ì´ ì»´í¬ë„ŒíŠ¸ì™€ ìƒëª…ì„ í•¨ê»˜í•˜ëŠ” ë³€ìˆ˜ 
        const stompRef = React.useRef(null);
        const subRef = React.useRef(null);
        const chatBoxRef = React.useRef(null); // ì±„íŒ… ë“±ë¡ ì‹œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ 

        // state (ìƒíƒœ/ë°”ì¸ë“œ)ë³€ìˆ˜ëŠ” uiì™€ ì—®ì¸ ë””ìì¸ê´€ë ¨ ìš”ì†Œ 
        const [status,setStatus] = React.useState("DISCONNECTED"); // í˜„ì¬ ì•± ì ‘ì†ìƒíƒœ ë³€ìˆ˜ 
        const [roomId,setRoomId] = React.useState(""); // ì‚¬ìš©ìì˜ ì±„íŒ…ë£¸ ë²ˆí˜¸
        const [name,setName] = React.useState(""); // ë¡œê·¸ì¸ ì‚¬ìš©ìëª… 
        const [emoji,setEmoji] = React.useState("ğŸ˜‘"); // ì´ëª¨í‹°ì½˜ 
        const [message,setMessage] = React.useState(""); // ì´ëª¨í‹°ì½˜ 
        const [messages,setMessages] = React.useState([]); // ë©”ì„¸ì§€ ì¶œë ¥ì— ì‚¬ìš©ë  ë°°ì—´ 

        // ì»´í¬ë„ŒíŠ¸ê°€ í™”ë©´ì— render ë ë•Œ ì›¹ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° 
        React.useEffect(()=>{
            fetch("http://localhost:9992/api/auth/me",{
                method:"GET",
                credentials:"include" // ì„¸ì…˜ì¿ í‚¤ë¥¼ ì£¼ê³ ë°›ê¸°ìœ„í•œ í•„ìˆ˜ì˜µì…˜ 
            })
            .then(res=>{
                if(!res.ok) throw new Error("ì—ëŸ¬ë°œìƒ");
                return res.json(); // Promise() ì˜ resolve() ì•ˆì— ë§¤ê°œë³€ìˆ˜ ì „ë‹¬ ... fulfiled ìƒíƒœë¡œ ì „í™˜ë˜ë©° ë‘ë²ˆì§¸ then()í˜¸ì¶œ.
            })
            .then(data=>{
                console.log(data.name," ì ‘ì†");
                setName(data.name);
            })
            .catch()
        },[]);

// ---------- ì„œë²„ ì ‘ì†
        const connect = ()=>{
            if(stompRef.current && stompRef.current.connected){// ì ‘ì†ìƒíƒœë¼ë©´? 
                return;
            } 

            setStatus("CONNECTING..."); // ì„œë²„ ì—°ê²°ì— ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²½ìš° ì‚¬ìš©ìì—ê²Œ ui ì œê³µ 
            const sock = new SockJS("http://localhost:9992/ws/stomp"); // ì›ë˜ ì‹¤ì œ ë°±ì—”ë“œì„œë²„ ip ì ëŠ”ê²ƒ! 
            const stomp = Stomp.over(sock); // stomp ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì›¹ì†Œìº£ ìœ„ì— ì–¹í˜€ì ¸ì„œ ëŒì•„ê°. 
            /*
                STOMP ë¥¼ ì´ìš©í•œ ì„œë²„ ì ‘ì† ì‹œë„.
                connect ë©”ì„œë“œì—” ë§¤ê°œë³€ìˆ˜ 3ê°œ í•„ìš”. 
                1. ì—°ê²° ì‹œ ë³´ë‚¼ STOMP í—¤ë”(sockì—ì„œ í•´ë†”ì„œ ë¹„ì›Œë†”ë„ëœë‹¤), ì„±ê³µì½œë°±,ì‹¤íŒ¨ì½œë°±
                2. ì„±ê³µì‹œ ì½œë°±í•¨ìˆ˜
                3. ì‹¤íŒ¨ì‹œ ì½œë°±í•¨ìˆ˜
            */
            stomp.connect({},()=>{
                setStatus("CONNECTED");
                stompRef.current = stomp; // ì „ì—­ë³€ìˆ˜ ì‚¬ìš© ì§€ì–‘í•˜ë¼. ì»´í¬ë„ŒíŠ¸ì˜ Ref.current ë³€ìˆ˜ì— ë‹´ì•„ë¼. 
            },
            (err)=>{
                console.log(err);
                setStatus("ERROR");
            }); 
        }

// ---------- ë©”ì„¸ì§€ ì „ì†¡

        // messages ê°€ ë³€ê²½ë ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ 
        React.useEffect(()=>{
            if(!chatBoxRef.current)return;
            chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
        },[messages]);

        const send = () => {
            // ì›¹ì†Œìº£ ì—°ê²°ì—¬ë¶€ ì²´í¬ 
            if(!stompRef.current||!stompRef.current.connected){
                alert("ë©”ì„¸ì§€ ì—°ê²°ì„ ìœ„í•´ ì ‘ì†ì„ í•´ì£¼ì„¸ìš”.");
                return;
            }
            if(!message){
                alert("ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”~!");
                return;
            }

            // ì„œë²„ê°€ ChatMessate ê°ì²´ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ë°›ê³ ìˆìœ¼ë¯€ë¡œ í•´ë‹¹ ê°ì²´ì— ë§ëŠ” json ê°ì²´ë¡œ ì „ë‹¬í•´ì¤˜ì•¼ í•œë‹¤. 
            const payload={
                name:name,
                emoji:emoji,
                message:message
            }
            console.log(payload);
            stompRef.current.send('/app/room/'+roomId+'/send',{},JSON.stringify(payload));
        }




// ---------- ë°© ì…ì¥(êµ¬ë… ì‹ ì²­)
        const joinRoom = ()=>{
            // ë¯¸ì ‘ì† joinRoom ì‹œë„ ë°©ì–´
            if(!stompRef.current || !stompRef.current.connected){
                altert("ë¨¼ì € ì ‘ì†ì„ í•´ì£¼ì„¸ìš”");
                return;
            }

            /*
              subscribe ë©”ì„œë“œì˜ ì¸ìˆ˜ 3ì¢… 
              1. destination(ì—°ê²°í•  ì£¼ì†Œ) // êµ¬ë… ì‹ ì²­ ì‹œ ì£¼ì†Œì™€ í•¨ê»˜ êµ¬ë… êµ¬ë¶„ì„ ìœ„í•œ id ê°€ í•¨ê»˜ ì „ì†¡ ë¨. 
              2. êµ¬ë… ì‹ ì²­ í›„ ì„œë²„ì—ì„œ ì „ì†¡ëœ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•  ì½œë°± í•¨ìˆ˜. ê°™ì€ ë°©ì— ìˆëŠ” ì‚¬ìš©ìë“¤ì˜ ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹œë¡œ ë°›ëŠ” í•¨ìˆ˜.
            */
            const rid=roomId.trim();
            if(!rid){ // roomId ê°€ ë¹„ì–´ìˆìœ¼ë©´~
                alert(rid+"ë£¸ ë²ˆí˜¸ ì…ë ¥í•´.");
                return;
            }

            // ì´ë¯¸ êµ¬ë…ì •ë³´ê°€ ìˆë‹¤ë©´ ê¸°ì¡´ êµ¬ë…ì •ë³´ í•´ì œ
            if(subRef.current){
                subRef.current.unsubscribe();
                subRef.current = null;
            }

            // ì¶”í›„ ë‹¤ë¥¸ ë©”ì„œë“œì—ì„œ êµ¬ë…ê°ì²´ ì ‘ê·¼ì„ ìœ„í•œ subRef 
            subRef.current = stompRef.current.subscribe('/topic/room/'+rid,
                (frame)=>{ // ì„œë²„ê°€ ì „ì†¡í•œ ë©”ì„¸ì§€ê°€ frame ìœ¼ë¡œ ë“¤ì–´ì˜´. 
                    console.log("frame is ",frame);

                    // ì‹¤ì œì ì¸ ë©”ì„¸ì§€ ë‚´ìš©ì€ body ì— json ë¬¸ìì—´ë¡œ ë“¤ì–´ìˆìœ¼ë¯€ë¡œ (@ResponseBody ë¡œ ë³´ëƒˆìŒ)
                    // ê°ì²´ë¡œ ë³€í™˜í•´ì¤˜ì•¼ í•¨.
                    const body = JSON.parse(frame.body);
                    console.log("ë©”ì„¸ì§€ ë‚´ìš© = ", body);
                    // ê¸°ì¡´ messages ë°°ì—´ì— body ì¶”ê°€í•œ ìƒˆë¡œìš´ ë°°ì—´ì„ ë°˜í™˜. 
                    setMessages(prev => [...prev,body]); 
                }
            );
        }

            
// ---------- ì ‘ì† í•´ì œ 
        const disconnect= ()=>{
            try{
                // ê¸°ì¡´ì˜ êµ¬ë…ì‹ ì²­ì´ ìˆë‹¤ë©´ + ì—°ê²°ì´ ì‚´ì•„ìˆë‹¤ë©´ êµ¬ë… í•´ì œ 
                if(subRef.current && stompRef.current){
                    subRef.current.unsubscribe(); // êµ¬ë… í•´ì œ 
                    subRef.current=null;
                }

                if(stompRef.current){
                    stompRef.current.disconnect(()=>{setStatus("DISCONNECTED");});
                    stompRef.current=null;
                }
            }catch(e){ // ë³´í†µ ìƒëµí•¨. ì‹¤ìµì´ ì—†ìŒ. 
            }finally{
                /*
                  disconnect() í˜¸ì¶œì— ì˜í•œ í•´ì œ ì‹¤íŒ¨í•œ ê²½ìš°ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ë‹¤.
                  ìœ ì €ê°€ ì ‘ì† í•´ì œë¥¼ ì‹œë„í•˜ë©´ ì–´ë–¤ ì´ìœ ì—ì„œê±´ ì—°ê²°ì´ ìœ ì§€ë  ìˆ˜ê°€ ì—†ìŒ.
                  1. ì´ë¯¸ ì„œë²„ê°€ ë¨¼ì € ì—°ê²°ì„ ëŠì€ê²½ìš°. (ì„œë²„ì˜ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, ì„œë²„ ì¢…ë£Œ)
                  2. ì†Œì¼“ì´ half-open ìƒíƒœì¼ ë•Œ 
                */
                setStatus("DISCONNECTED");
            }
        }
        
        
        
        return (
            <div className="wrap">
                <div className="card">
                    <h2 style={{ margin: "0 0 10px 0" }}>Step2+3 - STOMP ì±„íŒ…ë°©(Room) (No Auth)</h2>

                    <div className="row">
                    <div className="status">
                        <b>Status:</b> <span id="status">{status}</span>
                        <span id="room-pill" className="pill" style={{ display: "none" }}>Room </span>
                    </div>

                    <div style={{ flex: 1 }}></div>

                    <button className="ghost" id="btn-connect" onClick={connect}>Connect</button>
                    <button className="ghost" id="btn-disconnect" onClick={disconnect}>Disconnect</button>
                    </div>

                    <hr style={{ border: 0, borderTop: "1px solid #eee", margin: "14px 0" }} />

                    <div className="row">
                    <input
                        id="input-roomId"
                        type="text"
                        placeholder="roomId (ì˜ˆ: 1,2,study)"
                        value={roomId}
                        onChange={e=>{setRoomId(e.target.value)}}
                    />
                    <button className="primary" id="btn-join" onClick={joinRoom}>Join Room</button>

                    <div style={{ flex: 1 }}></div>

                    <input
                        id="input-nickname"
                        type="text"
                        placeholder="ë‹‰ë„¤ì„"
                        value={name}
                    />
                    <select id="select-emoji" value={emoji} onChange={e=>{setEmoji(e.target.value)}}>
                        <option value="ğŸ™‚">ğŸ™‚</option>
                        <option value="ğŸ˜„">ğŸ˜„</option>
                        <option value="ğŸ˜">ğŸ˜</option>
                        <option value="ğŸ”¥">ğŸ”¥</option>
                        <option value="ğŸ‰">ğŸ‰</option>
                        <option value="âœ…">âœ…</option>
                        <option value="âš ï¸">âš ï¸</option>
                        <option value="â¤ï¸">â¤ï¸</option>
                    </select>
                    </div>

                    <div style={{ marginTop: "14px" }} className="chatBox" id="chat-box" ref={chatBoxRef}>
                        {
                            messages.length === 0? (
                                /*ë©”ì‹œì§€ê°€ ì—†ì„ ê²½ìš°*/
                                (<div id="empty-message" style={{ opacity: 0.75 }}>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. Join Room í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.</div>)
                            ) : (
                                /*ë©”ì‹œì§€ê°€ ìˆì„ ê²½ìš°*/
                                messages.map((obj, idx)=>{
                                    return(
                                        <div className="msg">
                                            <div className="meta">
                                            <b>{obj.emoji} {obj.name}</b>
                                            <span style={{ marginLeft: 8 }}>
                                                {obj.time}
                                            </span>
                                            </div>
                                            <div className="text">{obj.message}</div>
                                        </div>
                                    )
                                })
                            )

                        }
                    </div>

                    <div className="row" style={{ marginTop: "12px" }}>
                    <input
                        id="input-message"
                        style={{ flex: 1, minWidth: "260px" }}
                        type="text"
                        placeholder="ë©”ì‹œì§€ ì…ë ¥"
                        value={message}
                        onChange={e=>{setMessage(e.target.value)}}
                        onKeyUp={e=>{
                            if(e.key ==="Enter" && !e.repeat)send(e.target.value);
                        }}
                    />
                    <button className="primary" id="btn-send" onClick={send}>Send</button>
                    </div>

                    <div style={{ marginTop: "10px", fontSize: "12px", color: "#666" }}>
                    WS ì ‘ì†: <code>/ws/stomp</code> / êµ¬ë…: <code>/topic/room/23</code> / ì „ì†¡: <code>/app/room/23"/send</code>
                    </div>
                </div>
            </div>
        )
    }    
    
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);

</script>    
</body>
</html>